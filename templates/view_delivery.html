{% extends "base.html" %}

{% block title %}Delivery Order {{ delivery.order_number }} - Skanda Enterprises{% endblock %}

{% block page_title %}Delivery Order {{ delivery.order_number }}{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="fas fa-truck me-2"></i>Delivery Order {{ delivery.order_number }}</h1>
            <div>
                {% if session.role == 'admin' %}
                <form method="POST" action="{{ url_for('delete_delivery', delivery_id=delivery.id) }}" 
                      style="display: inline;" 
                      onsubmit="return confirmDelete('{{ delivery.order_number }}')">
                    <button type="submit" class="btn btn-danger me-2">
                        <i class="fas fa-trash me-1"></i>Delete Delivery
                    </button>
                </form>
                {% endif %}
                <a href="{{ url_for('deliveries') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-1"></i>Back to Deliveries
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Delivery Details -->
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>Delivery Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-bordered">
                    <tr>
                        <th width="30%">Order Number</th>
                        <td><strong>{{ delivery.order_number }}</strong></td>
                    </tr>
                    <tr>
                        <th>Status</th>
                        <td>
                            {% if delivery.status == 'pending' %}
                                <span class="badge bg-warning"><i class="fas fa-clock me-1"></i>Pending</span>
                            {% elif delivery.status == 'in_transit' %}
                                <span class="badge bg-info"><i class="fas fa-shipping-fast me-1"></i>In Transit</span>
                            {% elif delivery.status == 'delivered' %}
                                <span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Delivered</span>
                            {% elif delivery.status == 'cancelled' %}
                                <span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Cancelled</span>
                            {% else %}
                                <span class="badge bg-secondary">{{ delivery.status }}</span>
                            {% endif %}
                            {% if delivery.is_confirmed %}
                                <span class="badge bg-success ms-2"><i class="fas fa-check-double me-1"></i>Confirmed</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Delivery Man</th>
                        <td>
                            {% if delivery.delivery_man %}
                                {{ delivery.delivery_man.full_name or delivery.delivery_man.username }}
                                {% if delivery.delivery_man.phone %}
                                    <small class="text-muted">({{ delivery.delivery_man.phone }})</small>
                                {% endif %}
                            {% else %}
                                <span class="text-muted">N/A</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Invoice</th>
                        <td>
                            {% if delivery.invoice %}
                                <a href="{{ url_for('view_invoice', invoice_id=delivery.invoice.id) }}" class="text-decoration-none">
                                    {{ delivery.invoice.invoice_number }}
                                </a>
                                <span class="text-muted ms-2">(₹{{ "%.2f"|format(delivery.invoice.bill_amount) }})</span>
                            {% else %}
                                <span class="text-muted">No Invoice Linked</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>Delivery Date</th>
                        <td>
                            {{ delivery.delivery_date.strftime('%d-%m-%Y') }}
                            {% if delivery.expected_time %}
                                <small class="text-muted">(Expected: {{ delivery.expected_time.strftime('%I:%M %p') }})</small>
                            {% endif %}
                        </td>
                    </tr>
                    {% if delivery.actual_delivery_time %}
                    <tr>
                        <th>Actual Delivery Time</th>
                        <td>
                            <strong class="text-success">{{ delivery.actual_delivery_time.strftime('%d-%m-%Y %I:%M %p') }}</strong>
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Delivery Address</th>
                        <td>
                            {% for line in delivery.delivery_address.split('\n') %}
                                {{ line }}<br>
                            {% endfor %}
                        </td>
                    </tr>
                    <tr>
                        <th>Customer Contact</th>
                        <td>
                            {% if delivery.customer_contact %}
                                <a href="tel:{{ delivery.customer_contact }}" class="text-decoration-none">
                                    <i class="fas fa-phone me-1"></i>{{ delivery.customer_contact }}
                                </a>
                            {% else %}
                                <span class="text-muted">Not provided</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% if delivery.delivery_remarks %}
                    <tr>
                        <th>Delivery Remarks</th>
                        <td>
                            {% for line in delivery.delivery_remarks.split('\n') %}
                                {{ line }}<br>
                            {% endfor %}
                        </td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Created</th>
                        <td>{{ delivery.created_at.strftime('%d-%m-%Y %I:%M %p') }}</td>
                    </tr>
                    {% if delivery.updated_at != delivery.created_at %}
                    <tr>
                        <th>Last Updated</th>
                        <td>{{ delivery.updated_at.strftime('%d-%m-%Y %I:%M %p') }}</td>
                    </tr>
                    {% endif %}
                </table>
            </div>
        </div>

        <!-- OCR Receipt (if available) -->
        {% if delivery.receipt_image %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-receipt me-2"></i>Delivery Receipt</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>Receipt Image</h6>
                        <img src="{{ url_for('static', filename='uploads/' + delivery.receipt_image) }}" 
                             alt="Receipt" class="img-fluid rounded" style="max-height: 300px;">
                    </div>
                    {% if delivery.receipt_ocr_text %}
                    <div class="col-md-6">
                        <h6>OCR Extracted Text</h6>
                        <div class="bg-light p-3 rounded" style="max-height: 300px; overflow-y: auto;">
                            <pre class="mb-0 small">{{ delivery.receipt_ocr_text }}</pre>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Status Update Panel -->
    <div class="col-md-4">
        {% if session.role in ['admin', 'delivery_man'] %}
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Update Status</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('update_delivery_status', delivery_id=delivery.id) }}">
                    <div class="mb-3">
                        <label for="status" class="form-label">Status *</label>
                        <select class="form-select" id="status" name="status" required>
                            <option value="pending" {% if delivery.status == 'pending' %}selected{% endif %}>Pending</option>
                            <option value="in_transit" {% if delivery.status == 'in_transit' %}selected{% endif %}>In Transit</option>
                            <option value="delivered" {% if delivery.status == 'delivered' %}selected{% endif %}>Delivered</option>
                            <option value="cancelled" {% if delivery.status == 'cancelled' %}selected{% endif %}>Cancelled</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="delivery_remarks" class="form-label">Remarks</label>
                        <textarea class="form-control" id="delivery_remarks" name="delivery_remarks" rows="3" 
                                  placeholder="Add any delivery remarks or notes...">{{ delivery.delivery_remarks or '' }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-save me-1"></i>Update Status
                    </button>
                </form>
            </div>
        </div>
        {% endif %}

        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    {% if delivery.invoice %}
                    <a href="{{ url_for('view_invoice', invoice_id=delivery.invoice.id) }}" class="btn btn-outline-primary">
                        <i class="fas fa-file-invoice me-1"></i>View Invoice
                    </a>
                    {% endif %}
                    {% if delivery.customer_contact %}
                    <a href="tel:{{ delivery.customer_contact }}" class="btn btn-outline-success">
                        <i class="fas fa-phone me-1"></i>Call Customer
                    </a>
                    {% endif %}
                    <a href="{{ url_for('deliveries') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-list me-1"></i>All Deliveries
                    </a>
                </div>
            </div>
        </div>

        <!-- Status Timeline -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-history me-2"></i>Status Timeline</h5>
            </div>
            <div class="card-body">
                <div class="timeline-small">
                    <div class="timeline-item-small">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content-small">
                            <strong>Created</strong>
                            <small class="text-muted d-block">{{ delivery.created_at.strftime('%d-%m-%Y %I:%M %p') }}</small>
                        </div>
                    </div>
                    {% if delivery.updated_at != delivery.created_at %}
                    <div class="timeline-item-small">
                        <div class="timeline-dot"></div>
                        <div class="timeline-content-small">
                            <strong>Status Updated</strong>
                            <small class="text-muted d-block">{{ delivery.updated_at.strftime('%d-%m-%Y %I:%M %p') }}</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if delivery.actual_delivery_time %}
                    <div class="timeline-item-small">
                        <div class="timeline-dot bg-success"></div>
                        <div class="timeline-content-small">
                            <strong>Delivered</strong>
                            <small class="text-muted d-block">{{ delivery.actual_delivery_time.strftime('%d-%m-%Y %I:%M %p') }}</small>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.timeline-small {
    position: relative;
    padding-left: 2rem;
}

.timeline-item-small {
    position: relative;
    padding-bottom: 1.5rem;
}

.timeline-item-small:not(:last-child)::before {
    content: '';
    position: absolute;
    left: -1.5rem;
    top: 1.25rem;
    width: 2px;
    height: calc(100% - 0.5rem);
    background: var(--gray-300);
}

.timeline-dot {
    position: absolute;
    left: -1.75rem;
    top: 0.25rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-color);
    border: 2px solid white;
    box-shadow: 0 0 0 2px var(--primary-color);
}

.timeline-dot.bg-success {
    background: var(--success-color);
    box-shadow: 0 0 0 2px var(--success-color);
}

.timeline-content-small {
    padding-left: 0.5rem;
}
</style>

<script>
function confirmDelete(orderNumber) {
    return confirm(
        '⚠️ WARNING: Delete Delivery Order\n\n' +
        'Are you sure you want to delete delivery order ' + orderNumber + '?\n\n' +
        'This action cannot be undone and all associated data will be permanently removed.\n\n' +
        'Click OK to delete or Cancel to abort.'
    );
}
</script>
{% endblock %}

